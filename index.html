<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç½®å‘é€ç³»ç»Ÿ (é«˜å¾·ç‰ˆ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f4f9; }
        .container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        h2 { color: #333; margin-bottom: 1.5rem; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 5px; cursor: pointer; transition: background 0.3s; width: 100%; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; text-align: left; font-size: 14px; line-height: 1.6; word-wrap: break-word; }
        .log-item { margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .address-info { font-size: 12px; color: #666; margin-top: 2px; }
    </style>

    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: 'bbedba2a905f7c70609d2fe9616bd10e', // âœ… å·²å¡«å…¥æ‚¨çš„å®‰å…¨å¯†é’¥
        };
    </script>

    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=d6dac34648512c1dedfa82fe5d363d19"></script> 
</head>
<body>

    <div class="container">
        <h2>ğŸ“ é«˜å¾·ç²¾ç¡®å®šä½ç³»ç»Ÿ</h2>
        <p style="color: #666; margin-bottom: 20px;">ç³»ç»Ÿæ­£åœ¨å°è¯•è°ƒç”¨é«˜å¾· LBS è·å–ä½ç½®...</p>
        
        <button id="btn" onclick="startProcess()">æ­£åœ¨åˆå§‹åŒ–...</button>

        <div id="status"></div>
    </div>

    <script>
        // âš ï¸ æ³¨æ„ï¼šå¦‚æœä½ çš„ Ngrok é‡å¯è¿‡ï¼Œè¯·åŠ¡å¿…æ›´æ–°ä¸‹é¢çš„ URL
        const SERVER_URL = "https://vincent-unmeasurable-fiducially.ngrok-free.dev/api/receive_location";

        window.onload = function() {
            log("é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡åˆå§‹åŒ–é«˜å¾·åœ°å›¾ç»„ä»¶...");
            // æ£€æŸ¥é«˜å¾·æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof AMap === 'undefined') {
                log("âŒ é”™è¯¯: é«˜å¾·åœ°å›¾è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ", "error");
                document.getElementById('btn').innerText = "è„šæœ¬åŠ è½½å¤±è´¥";
                return;
            }
            startProcess(); 
        };

        function log(msg, type = 'normal', detail = '') {
            const statusDiv = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            let colorStr = type === 'error' ? 'color:red' : (type === 'success' ? 'color:green' : 'color:#333');
            
            let html = `<div class="log-item" style="${colorStr}">
                            <div>[${time}] ${msg}</div>
                            ${detail ? `<div class="address-info">${detail}</div>` : ''}
                        </div>`;
            statusDiv.innerHTML += html;
        }

        function startProcess() {
            const btn = document.getElementById('btn');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨å®šä½ (AMap)...";
            log("æ­£åœ¨è°ƒç”¨é«˜å¾· Geolocation æ’ä»¶...");

            // âœ… ä½¿ç”¨é«˜å¾·åœ°å›¾å®šä½æ’ä»¶
            AMap.plugin('AMap.Geolocation', function() {
                var geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true, // æ˜¯å¦ä½¿ç”¨é«˜ç²¾åº¦å®šä½
                    timeout: 10000,           // è¶…è¿‡10ç§’ååœæ­¢å®šä½
                    positionDom: false,       // ä¸æ˜¾ç¤ºå®šä½æŒ‰é’®
                    zoomToAccuracy: true,     // å®šä½æˆåŠŸåè°ƒæ•´åœ°å›¾è§†é‡èŒƒå›´
                    needAddress: true         // ğŸ”´ æ ¸å¿ƒåŠŸèƒ½ï¼šæ˜¯å¦éœ€è¦å°†ç»çº¬åº¦è§£æä¸ºåœ°å€ä¿¡æ¯
                });

                geolocation.getCurrentPosition(function(status, result) {
                    if(status == 'complete'){
                        onComplete(result);
                    }else{
                        onError(result);
                    }
                });
            });
        }

        // âœ… å®šä½æˆåŠŸçš„å›è°ƒ
        function onComplete(data) {
            const formattedAddress = data.formattedAddress || "æœªçŸ¥åœ°å€"; // è·å–å…·ä½“åœ°å€
            
            log(`âœ… å®šä½æˆåŠŸ`, "success", `åœ°å€: ${formattedAddress}`);
            log(`çº¬åº¦: ${data.position.lat}, ç»åº¦: ${data.position.lng}`);

            // æ„é€ å‘é€ç»™åç«¯çš„æ•°æ®
            const payload = {
                latitude: data.position.lat,
                longitude: data.position.lng,
                accuracy: data.accuracy,
                address: formattedAddress, // å‘é€å…·ä½“åœ°å€
                province: data.addressComponent.province,
                city: data.addressComponent.city,
                district: data.addressComponent.district,
                timestamp: new Date().toISOString(),
                source: 'AMap_API'
            };

            sendData(payload);
        }

        // âŒ å®šä½å¤±è´¥çš„å›è°ƒ
        function onError(data) {
            let errorMsg = data.message || "æœªçŸ¥é”™è¯¯";
            // å¸¸è§é”™è¯¯å¤„ç†
            if (data.info === 'NOT_SUPPORTED') errorMsg = "æµè§ˆå™¨ä¸æ”¯æŒå®šä½";
            if (data.info === 'FAILED') errorMsg = "å®šä½å¤±è´¥ (è¯·æ£€æŸ¥æ‰‹æœºGPSæˆ–HTTPS)";
            if (data.info === 'PERMISSION_DENIED') errorMsg = "ç”¨æˆ·æ‹’ç»äº†å®šä½æƒé™";
            
            log(`âŒ å®šä½å¤±è´¥: ${errorMsg}`, "error");
            document.getElementById('btn').disabled = false;
            document.getElementById('btn').innerText = "å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•";
        }

        function sendData(data) {
            log("æ­£åœ¨å‘é€æ•°æ®åˆ°æœåŠ¡å™¨...");

            fetch(SERVER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(data)
            })
            .then(async (response) => {
                if (response.ok) {
                    const json = await response.json();
                    log("ğŸš€ å‘é€æˆåŠŸï¼æœåŠ¡å™¨å·²æ¥æ”¶ã€‚", "success");
                    document.getElementById('btn').innerText = "å‘é€æˆåŠŸ (ç‚¹å‡»å†æ¬¡å‘é€)";
                } else {
                    log(`âš ï¸ æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`, "error");
                    document.getElementById('btn').innerText = "å‘é€å‡ºé”™ (ç‚¹å‡»é‡è¯•)";
                }
            })
            .catch((error) => {
                log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, "error");
                document.getElementById('btn').innerText = "ç½‘ç»œé”™è¯¯ (ç‚¹å‡»é‡è¯•)";
            })
            .finally(() => {
                document.getElementById('btn').disabled = false;
            });
        }
    </script>

</body>
</html>
