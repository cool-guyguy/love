<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ¥è¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; }
        .card { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #f8f9fa; }
        h3 { margin-top: 0; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-right: 10px; }
        .log { background: #222; color: #fff; padding: 15px; border-radius: 5px; font-family: monospace; min-height: 150px; white-space: pre-wrap; word-break: break-all;}
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #ff5252; font-weight: bold; }
        .warn { color: #ffeb3b; }
    </style>
</head>
<body>

    <h2>ğŸ› ï¸ æœåŠ¡å™¨è¿æ¥è¯Šæ–­</h2>
    <p>å¦‚æœæ­¤é¡µé¢æ˜¯é€šè¿‡ <b>https://</b> å¼€å¤´çš„åœ°å€è®¿é—®çš„ï¼Œå‘é€åŠŸèƒ½ 100% ä¼šå¤±è´¥ã€‚</p>

    <div class="card">
        <h3>æ­¥éª¤ 1: åŸºç¡€ç½‘ç»œæµ‹è¯•</h3>
        <p>ä¸è·å–ä½ç½®ï¼Œä»…å°è¯•å‘æœåŠ¡å™¨å‘ä¸€ä¸ª "Hello" åŒ…ã€‚</p>
        <button onclick="testConnection()">æµ‹è¯•æœåŠ¡å™¨è¿æ¥</button>
    </div>

    <div class="card">
        <h3>æ­¥éª¤ 2: è·å–å¹¶å‘é€ä½ç½®</h3>
        <p>è¯·æ±‚ GPS æƒé™å¹¶å‘é€æ•°æ®ã€‚</p>
        <button onclick="getFullLocation()">è·å–å¹¶å‘é€</button>
    </div>

    <div class="log" id="console">ç³»ç»Ÿå°±ç»ª...</div>

    <script>
        // æ³¨æ„ï¼šç»“å°¾è¦åŠ ä¸Š /api/receive_location
const SERVER_URL = "https://vincent-unmeasurable-fiducially.ngrok-free.app/api/receive_location";
        function log(text, type='info') {
            const el = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            let color = '#fff';
            if(type==='error') color = '#ff5252';
            if(type==='success') color = '#4caf50';
            
            el.innerHTML += `<br><span style="color:${color}">[${time}] ${text}</span>`;
            el.scrollTop = el.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        }

        // æ£€æŸ¥é¡µé¢ç¯å¢ƒ
        if (window.location.protocol === 'https:') {
            log("âš ï¸ è­¦å‘Š: å½“å‰é¡µé¢æ˜¯ HTTPS åè®®ï¼Œæµè§ˆå™¨ä¼šæ‹¦æˆªå¯¹ HTTP æœåŠ¡å™¨çš„è¯·æ±‚ï¼è¯·æ”¹ä¸º file:// æˆ– http:// è®¿é—®ã€‚", "error");
        }

        // æ ¸å¿ƒå‘é€å‡½æ•°
        async function sendData(payload, description) {
            log(`æ­£åœ¨å°è¯•å‘é€ ${description}...`);
            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const json = await response.json();
                    log(`âœ… å‘é€æˆåŠŸ! æœåŠ¡å™¨å›åº”: ${JSON.stringify(json)}`, 'success');
                } else {
                    log(`âŒ æœåŠ¡å™¨è¿ä¸Šäº†ï¼Œä½†è¿”å›é”™è¯¯: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (err) {
                console.error(err);
                log(`âŒ å‘é€å¤±è´¥ (Failed to fetch)`, 'error');
                log(`å¯èƒ½åŸå› :\n1. æ··åˆå†…å®¹: ç½‘é¡µæ˜¯HTTPSè€ŒæœåŠ¡å™¨æ˜¯HTTP\n2. è·¨åŸŸ(CORS): åç«¯æ²¡å¼€å¯CORS\n3. æ’ä»¶æ‹¦æˆª: è¯·å…³é—­å¹¿å‘Šæ‹¦æˆªå™¨`, 'warn');
            }
        }

        // æµ‹è¯• 1: ä»…æµ‹è¯•è¿æ¥
        function testConnection() {
            sendData({ message: "Ping Test", timestamp: new Date() }, "æµ‹è¯•æ•°æ®åŒ…");
        }

        // æµ‹è¯• 2: å®Œæ•´æµç¨‹
        function getFullLocation() {
            log("æ­£åœ¨è¯·æ±‚ä½ç½®æƒé™...");
            if (!navigator.geolocation) return log("æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®", "error");

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const data = {
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        accuracy: pos.coords.accuracy
                    };
                    log(`ğŸ“ è·å–åˆ°ä½ç½®: ${data.latitude}, ${data.longitude}`, 'success');
                    sendData(data, "çœŸå®ä½ç½®æ•°æ®");
                },
                (err) => {
                    log(`âŒ å®šä½å¤±è´¥: ${err.message}`, 'error');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
    </script>
</body>
</html>
